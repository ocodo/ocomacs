#!/bin/bash

export EMACSDIR=${EMACSDIR:-~/.emacs.d}
export OCOMACSNAME=$(basename $0)
export BINDIR=$(dirname $0)
export OCOMACS_GITHUB=https://github.com/ocodo/ocomacs
export OCOMACS_REMOTE=ocomacs

ocomacs-help() {
    cat <<EOF

$(cat $BINDIR/ocomacs-header.ansi)

   ...a post-doom, Emacs config framework for Linux, Macos, WSL2/Linux

   Usage: $OCOMACSNAME [subcommand]

   build    - install build emacs packages from $EMACSDIR/packages.el
   prune    - remove unused packages
   clean    - remove straight installed emacs packages
   rebuild  - clean and build
   list	    - list installed packages
   commit   - stage all changes, begin commit message in $EDITOR
   push     - push changes to upstream once set
   pull     - pull changes from upstream once set
   sync     - pull/view latest changes from ocodo/ocomacs
   docs     - project docs
   help	    - this message
[0m
EOF
}

ocomacs-syncup-log() {
    echo "sync view log"
}

ocomacs-syncup-diff() {
    echo "sync view diff"
}

ocomacs-syncup-fetch() {
    echo "sync fetch"
}

ocomacs-syncup-pull() {
    echo "sync pull"
}

ocomacs-syncup-help() {
    cat <<EOF

$(cat $BINDIR/ocomacs-header.ansi)

   ocomacs sync

   log      - view commit log between ocodomacs and local
   diff     - view diff of ocodomacs and local
   fetch    - fetch update commits from ocomacs
   pull     - pull rebase from ocodomacs

EOF
}

ocomacs-syncup() {
    case $1 in
	fetch )
            ocomacs-syncup-fetch
            ;;
	
	pull )
            ocomacs-syncup-pull
            ;;

	log )
            ocomacs-syncup-log
            ;;
	
	diff )
            ocomacs-syncup-diff
            ;;

	* )
	    ocomacs-syncup-help
    esac
}

ocomacs-docs() {
    if which bat > /dev/null 2> /dev/null; then
	less -f <(cat $BINDIR/ocomacs-header.ansi $EMACSDIR/README.md | sed -e 's/.*<center>.*//')
    else
	bat --style=plain <(cat $BINDIR/ocomacs-header.ansi <(echo "\n\n") $EMACSDIR/README.md)
    fi
}

straight-clean() {
    # clean straight
    rm -rf $EMACSDIR/straight/
}

straight-build() {
    emacs --batch --load $EMACSDIR/init.el
}

straight-prune() {
    emacs --batch --load $EMACSDIR/lisp/straight-prune.el
}

straight-list-built() {
    ls -1 $EMACSDIR/straight/build
}

case $1 in
    sync )
	shift 1
	ocomacs-syncup $@
	;;
    
    clean )
        straight-clean
        ;;
    
    build )
        straight-build
        ;;
    
    rebuild )	
        straight-clean
        straight-build
        ;;

    pull )
	git -C $EMACSDIR pull --rebase --autostash
	;;

    commit )
	git -C $EMACSDIR add --all
	git -C $EMACSDIR commit
	;;

    push )
	git -C $EMACSDIR push
	;;
    
    prune )	
        straight-prune
        ;;

    list )	
        straight-list-built
        ;;

    docs )	
        ocomacs-docs
        ;;
    *)
	ocomacs-help
esac
